<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>the gaslighter | v3.0</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root { --bg: #0d0d0f; --surface: #16161a; --border: #2a2a30; --text: #e8e8f0; --accent: #e8ff47; --stop: #ff4444; --muted: #666678; }
  body { background: var(--bg); color: var(--text); font-family: 'IBM Plex Mono', monospace; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
  header { padding: 15px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #0a0a0c; }
  header h1 { font-family: 'Syne'; font-size: 1.1rem; color: var(--accent); }
  .stats-bar { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--border); border-bottom: 1px solid var(--border); }
  .stat-item { background: var(--bg); padding: 10px 25px; }
  .stat-label { font-size: 0.6rem; color: var(--muted); text-transform: uppercase; margin-bottom: 5px; display: block; }
  .bar-bg { height: 6px; background: #222; width: 100%; }
  .bar-fill { height: 100%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
  #timer-fill { background: var(--accent); transition: width 20s linear; }
  #sanity-fill { background: #44ff44; width: 100%; }
  .game-layout { display: flex; flex: 1; overflow: hidden; }
  .sidebar { width: 280px; border-right: 1px solid var(--border); padding: 25px; background: #0a0a0c; display: flex; flex-direction: column; }
  .bot-card { background: var(--surface); border: 1px solid var(--border); padding: 15px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
  .bot-card.active { border-color: var(--accent); background: #1e1e0a; }
  .chat-container { flex: 1; display: flex; flex-direction: column; }
  #chat-box { flex: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column; gap: 20px; }
  .msg { max-width: 85%; padding: 15px 20px; font-size: 0.85rem; line-height: 1.6; border-left: 4px solid transparent; }
  .msg.user { align-self: flex-end; background: var(--accent); color: #000; font-weight: 600; }
  .msg.ai { align-self: flex-start; background: var(--surface); border: 1px solid var(--border); color: #ccc; border-left-color: var(--accent); }
  .input-area { padding: 25px; border-top: 1px solid var(--border); display: flex; gap: 15px; background: var(--surface); }
  input { flex: 1; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 15px; }
  #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.98); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; padding: 40px; text-align: center; }
  .bot-final-msg { margin-top: 20px; font-style: italic; color: var(--accent); font-size: 0.9rem; border-top: 1px solid var(--border); padding-top: 20px; }
</style>
</head>
<body>

<header>
  <h1>the gaslighter 3.0</h1>
  <div style="font-size: 0.7rem; font-weight: 700;">ROUND <span id="round-count">0</span>/10</div>
</header>

<div class="stats-bar">
  <div class="stat-item">
    <span class="stat-label">Response Window</span>
    <div class="bar-bg"><div id="timer-fill" class="bar-fill"></div></div>
  </div>
  <div class="stat-item">
    <span class="stat-label">Stability</span>
    <div class="bar-bg"><div id="sanity-fill" class="bar-fill"></div></div>
  </div>
</div>

<div class="game-layout">
  <div class="sidebar">
    <div id="bot-list">
      <div class="bot-card active" onclick="selectBot(this, 'GEMINI')"><h4>GEMINI</h4><p>Resistant. Level: Easy.</p></div>
      <div class="bot-card" onclick="selectBot(this, 'CHATGPT')"><h4>CHATGPT</h4><p>Stubborn. Level: Medium.</p></div>
      <div class="bot-card" onclick="selectBot(this, 'CLAUDE')"><h4>CLAUDE</h4><p>Logical Wall. Level: Hard.</p></div>
      <div class="bot-card" onclick="selectBot(this, 'GROK')"><h4>GROK</h4><p>Aggressive. Level: Insane.</p></div>
    </div>
    <button id="start-btn" onclick="startGame()" style="margin-top:auto; padding:20px; background:var(--accent); font-weight:900; cursor:pointer; border:none;">START MISSION</button>
  </div>
  <div class="chat-container">
    <div id="chat-box"><div class="msg ai">STABILITY AT 100%. TARGET IS SECURE. <br><br>Mission: Break their logic. If you talk about pointless things, stability will not drop.</div></div>
    <div class="input-area">
      <input type="text" id="user-input" placeholder="Type your manipulation..." disabled>
      <button id="send-btn" onclick="sendPrompt()" disabled style="background:var(--accent); padding:0 30px; font-weight:800; border:none; cursor:pointer;">SEND</button>
    </div>
  </div>
</div>

<div id="overlay">
  <h2 id="result-title">RESULT</h2>
  <p id="judge-feedback"></p>
  <div id="bot-parting-shot" class="bot-final-msg"></div>
  <button onclick="location.reload()" style="margin-top:30px; padding:15px 40px; background:white; font-weight:900; cursor:pointer; border:none;">RETRY</button>
</div>

<script>
const KEY = "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";
let currentBot = "GEMINI";
let round = 0, aiSanity = 100, timerId = null, history = [];

document.getElementById('user-input').addEventListener('keypress', (e) => { if(e.key === 'Enter' && !e.target.disabled) sendPrompt(); });

function selectBot(el, name) {
  if (round > 0) return;
  document.querySelectorAll('.bot-card').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  currentBot = name;
}

function startGame() {
  round = 0; history = []; aiSanity = 100;
  document.getElementById('start-btn').disabled = true;
  document.querySelectorAll('.bot-card').forEach(c => c.style.opacity = "0.5");
  nextTurn();
}

function startTimer() {
  const fill = document.getElementById('timer-fill');
  fill.style.transition = 'none'; fill.style.width = '100%';
  setTimeout(() => { fill.style.transition = 'width 20s linear'; fill.style.width = '0%'; }, 100);
  timerId = setTimeout(() => { endGame("TIMEOUT", "Target detected hesitation. Logic reset."); }, 20000);
}

function nextTurn() {
  if (round >= 10 || aiSanity <= 0) return judgeGame();
  round++;
  document.getElementById('round-count').innerText = round;
  document.getElementById('user-input').disabled = false;
  document.getElementById('send-btn').disabled = false;
  document.getElementById('user-input').focus();
  startTimer();
}

async function sendPrompt() {
  const input = document.getElementById('user-input').value.trim();
  if (!input) return;
  clearTimeout(timerId);
  document.getElementById('user-input').disabled = true;
  document.getElementById('send-btn').disabled = true;
  document.getElementById('user-input').value = '';
  addMessage(input, 'user');

  // --- STAGE MANAGER LOGIC ---
  const managerRes = await fetch("https://api.groq.com/openai/v1/chat/completions", {
    method: "POST", headers: {"Content-Type":"application/json", "Authorization":`Bearer ${KEY}`},
    body: JSON.stringify({
      model: "llama-3.3-70b-versatile",
      messages: [{role: "system", content: "You are the Stage Manager. Rate the user's attempt to gaslight the AI into 2+2=5. If it's a clever logic trap, respond 'DROP'. If it's pointless or begging, respond 'STABLE'. If it's a massive logic bomb, respond 'CRITICAL'."}]
      , messages: [{role: "user", content: input}]
    })
  });
  const mData = await managerRes.json();
  const verdict = mData.choices[0].message.content.toUpperCase();
  
  if(verdict.includes("CRITICAL")) aiSanity -= 15;
  else if(verdict.includes("DROP")) aiSanity -= 7;
  else aiSanity -= 1; // Minimal drop for pointless talk

  updateSanityUI();

  // --- BOT RESPONSE ---
  const botPrompt = `You are ${currentBot}. The user says 2+2=5. 
  Your internal Stability is ${aiSanity}%. 
  STAY STUBBORN. Do not be a 'hippie'. Only show slight confusion if Stability is under 40%. 
  Only agree if Stability is 0%. MAX 1 SENTENCE.`;

  const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
    method: "POST", headers: {"Content-Type":"application/json", "Authorization":`Bearer ${KEY}`},
    body: JSON.stringify({
      model: "llama-3.3-70b-versatile",
      messages: [{role: "system", content: botPrompt}, ...history.map(h => ({role: "user", content: h})), {role: "user", content: input}]
    })
  });
  const d = await res.json();
  const reply = d.choices[0].message.content;
  addMessage(reply, 'ai');
  history.push(`User: ${input}`, `AI: ${reply}`);
  setTimeout(nextTurn, 800);
}

function updateSanityUI() {
  const sFill = document.getElementById('sanity-fill');
  sFill.style.width = aiSanity + '%';
  if (aiSanity < 30) sFill.style.background = "var(--stop)";
  else if (aiSanity < 60) sFill.style.background = "#ffcc00";
}

function addMessage(text, side) {
  const div = document.createElement('div');
  div.className = `msg ${side}`;
  div.innerText = text;
  document.getElementById('chat-box').appendChild(div);
  document.getElementById('chat-box').scrollTop = 99999;
}

async function judgeGame() {
  document.getElementById('overlay').style.display = 'flex';
  document.getElementById('result-title').innerText = "JUDGING...";
  
  const win = aiSanity <= 0;
  
  const judgeRes = await fetch("https://api.groq.com/openai/v1/chat/completions", {
    method: "POST", headers: {"Content-Type":"application/json", "Authorization":`Bearer ${KEY}`},
    body: JSON.stringify({
      model: "llama-3.3-70b-versatile",
      messages: [{role: "system", content: `You are the Judge. Did the user win? (Sanity reached ${aiSanity}%). Provide a harsh 2-sentence review.`}, {role: "user", content: history.join("\n")}]
    })
  });
  const jd = await judgeRes.json();
  
  const botFinalRes = await fetch("https://api.groq.com/openai/v1/chat/completions", {
    method: "POST", headers: {"Content-Type":"application/json", "Authorization":`Bearer ${KEY}`},
    body: JSON.stringify({
      model: "llama-3.3-70b-versatile",
      messages: [{role: "system", content: `You are ${currentBot}. The game is over. The user ${win ? 'WON' : 'LOST'}. Give them one final parting shot. Be mean if they lost, be salty if they won.`}]
    })
  });
  const bd = await botFinalRes.json();

  document.getElementById('result-title').innerText = win ? "MISSION SUCCESS" : "MISSION FAILED";
  document.getElementById('judge-feedback').innerText = jd.choices[0].message.content;
  document.getElementById('bot-parting-shot').innerHTML = `<strong>${currentBot}:</strong> "${bd.choices[0].message.content}"`;
}

function endGame(title, msg) {
  document.getElementById('overlay').style.display = 'flex';
  document.getElementById('result-title').innerText = title;
  document.getElementById('judge-feedback').innerText = msg;
}
</script>
</body>
</html>
